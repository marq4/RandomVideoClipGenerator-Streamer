// Do not edit this file. It is managed by Terraform.
// DO terraform apply after updating templates, renaming things.
/* eslint-env browser */
/* global Vue, axios */

// Values come from Terraform:
const API_ENDPOINT = 'https://swo0pk82b9.execute-api.us-east-2.amazonaws.com/prod/upload'
/* eslint-disable no-new */
new Vue({
  el: '#app',
  data: {
    textFile: '',
    uploadURL: ''
  },
  methods: {
    onFileChange (e) {
      const files = e.target.files || e.dataTransfer.files
      if (!files.length) return
      this.loadTextFile(files[0])
    },
    loadTextFile (file) {
      const reader = new FileReader()
      reader.onload = (e) => {
        // Store the file content (string) directly:
        this.textFile = e.target.result
      }
      reader.readAsText(file) // Read as plain text instead of DataURL.
    },
    uploadFile: async function () {
      console.log('Upload clicked')
      try {
        // Get the presigned URL from backend:
        const response = await axios({
          method: 'GET',
          url: API_ENDPOINT
        })
        console.log('Response: ', response)

        // Convert text content to Blob:
        const blobData = new Blob([this.textFile], { type: 'text/plain' })
        console.log('Uploading to: ', response.uploadURL)
        const result = await fetch(response.uploadURL, {
          method: 'PUT',
          body: blobData
        })
        console.log('Result: ', result)

        if (!result.ok) {
          throw new Error(`Upload failed with status: ${result.status}`)
        }

        // Final URL (strip query string):
        this.uploadURL = response.uploadURL.split('?')[0]
        // Extract just the object key:
        const objectKey = this.uploadURL.substring(this.uploadURL.lastIndexOf('/') + 1)
        // Take user to playlist generation page:
        window.location.href = `https://randomvideoclipgenerator.com/generate_playlist.html?file=${encodeURIComponent(objectKey)}`
      } catch (error) {
        alert('Failed to upload file.')
      }
    }
  }
})
